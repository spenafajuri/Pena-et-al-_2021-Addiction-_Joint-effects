---
title: "R code for submitted manuscript"
author: "Pe√±a S et al"
date: "10 December 2019"
output:
  pdf_document: default
  word_document: default
  sansfont: Times New Roman
---


# Joint effects of alcohol use, smoking and obesity as an explanation for the alcohol harm 
paradox: causal mediation analysis of eight cohort studies

## Background
The study aimed to (1) examine the existence of joint effects between SES, alcohol use, 
smoking and BMI and (2) to quantify the extent to which socioeconomic inequalities in 
alcohol-attributable mortality are explained by these behavioural risk factors and their 
joint effects.


We used pooled data from eight Finnish population cohorts linked to mortality data. The 
analyses use Aalen additive hazard models (specifically the semiparametric version 
developed by McKeague and Sasieni. We used attained age as the time scale. We used 
complete case analysis and any subjects with missing data were excluded from the analyses. 
We used Stata to harmonise the variables and create the final dataset (code available upon 
request). Most exploratory data analyses were also done in Stata.


## Methods
We used Aalen hazard models to obtain additive interactions directly. The models are 
adjusted to survey round, age (as timescale), sex and marital status. The timereg package 
does not allow for complex sampling designs, which was the case of two out of the eight 
surveys used in the study. Given the proportional hazards assumption was not met, we 
assessed the impact in sensitivity analyses. More details are provided in each of the 
sections.

R version 3.6.3


## Loading and subsetting the biomarkers dataset


```{r setup, eval=FALSE}
library(readstata13)
library(foreign)
library(dplyr)
library(ggfortify)
library(lattice)
library(gridExtra)
library(grid)
library(ggplot2)
library(base)
library(tableone)
library(survival)
library(survminer)
library(Epi)
library(timereg)
library(VGAM)
library(nnet)
library(boot)
library(MASS)
library(biostat3)
setwd("~/")

#Loading full dataset 
biomarkers <- read.dta13("biomarkers.dta")

```

## Management of variable

The dataset was created in Stata (script available upon request), but the classes and levels are not always correctly imported.


```{r management, eval=FALSE, results='asis'}

options(scipen=999)

#Checking variable types
class(biomarkers$age_5)
class(biomarkers$smokstatus)
levels(biomarkers$smokstatus)
class(biomarkers$alcohol7d_5)

#Income
#Converting into a factor variable with correct labels
biomarkers$income_5 <- factor(biomarkers$income_5, levels = c(5,1,2,3,4))

#Converting smoking status into factor
biomarkers$smokstatus <- as.factor(biomarkers$smokstatus)

#Converting BMI into categorical after testing for linearity
biomarkers$bmicat<-cut(biomarkers$bmi, c(0, 18.5, 25, 30, Inf))
class(biomarkers$bmicat)
levels(biomarkers$bmicat)
biomarkers$bmicat <- factor(biomarkers$bmicat, levels = c("(18.5,25]","(0,18.5]", 
                      "(25,30]", "(30,Inf]"))

#Convert dataid into a categorical variable
biomarkers$dataid   <- factor(biomarkers$dataid, levels = 1:8, 
                              labels =c("MFS78", "FINRISK82", "FINRISK87",
                                        "FINRISK92", "FINRISK97", "H2000",
                                        "FINRISK02", "FINRISK07"))

levels(biomarkers$alcohol7d_5)
table(biomarkers$alcohol7d_5)

#Recoding and converting alcohol variable into factor
biomarkers <- biomarkers %>%
  mutate(alcohol7d_4 = recode(alcohol7d_5, '3'=4, '2'=3, '1'=2, '0'=1)) %>%
  mutate(alcohol7d_4 = factor(alcohol7d_4, c(1,2,3,4)))
table(biomarkers$alcohol7d_4)
levels(biomarkers$alcohol7d_4)

#Subsetting to a compact, complete case analysis versions for income 
interactionsincome <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, age_5, dataid, 
                smokstatus, maritalstatus, bmi, bmicat, alcohol7d_5, 
                alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, age_5, 
                        dataid, smokstatus, maritalstatus, bmi, bmicat, 
                        alcohol7d_5, alcohol7d_4, dataid))
summary(interactionsincome)
table(interactionsincome$dataid)
```

## Table 1


```{r table1, eval=FALSE}

#Events, persons-time and event rates
survRate(Surv(bl_age, end_age, statusbin)~1, data=interactionsincome)
survRate(Surv(bl_age, end_age, statusbin)~income_5, data=interactionsincome)
survRate(Surv(bl_age, end_age, statusbin)~age_5, data=interactionsincome)

#Frequencies and means of covariates stratified by dataid
listVars <- c( "statusbin", "bl_age", "sex", "maritalstatus", "alcohol7d_4",
               "smokstatus", "bmicat")
catVars <- c("statusbin", "sex", "smokstatus", "maritalstatus")
table1 <- CreateTableOne(listVars, strata = c("income_5"), factor=catVars,
                         test=FALSE,
data=interactionsincome)
tab1 <- print(table1, printToggle = FALSE, noSpaces = TRUE, format="p") 
knitr::kable(tab1,format.args =list(digits=4,nsmall=2))

#For main text
maintext <- CreateTableOne(listVars, factor=catVars, test=FALSE, 
data=interactionsincome)
text1 <- print(maintext, printToggle = FALSE, noSpaces = TRUE, format="p") 
knitr::kable(text1,format.args =list(digits=4,nsmall=2))


```


## Examining the existence of joint effects

In model 4, we tested for the time-invariant assumption (equivalent to the proportional 
hazard assumption in Cox proportional hazards models) by including all mediators and 
confounders without the wrapper "const". The output includes two tests for time-invariant 
effects (the Kolmogorov-Smirnov and the Cramer von Mises) and provide a p-value for each 
variable. Sex, marital status and alcohol use show time-variant effects (i.e. the effect 
is not constant over time). Therefore, sex and marital status were included in the model 
as time-varying covariates. We carried out sensitivity analises by age subgroups (where 
the time-invariant assumption was met) to examine the impact of modeling alcohol use as 
time-invariant.

We then examined the existence of exposure-mediator and mediator-mediator interactions 
examining the 95% confidence intervals of the interaction terms (Rod 2012). Aalen additive 
hazard models in R do not allow performing likehood ratio tests, BIC or AIC, it seems the 
only method possible to estimate whether these interactions exist.   
1. SES and alcohol
2. SES and smoking
3. Alcohol and smoking
4. SES and BMI
5. Alcohol and BMI

## Joint effects

```{r joint effects, eval=FALSE}

#Testing the existence of interactions
##Model 1 adjusted to sex and data cohort
mod_aalen1 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + factor(dataid) + 
factor(maritalstatus), data=interactionsincome) 
summary(mod_aalen1) #Sex is age-varying and will be modeled as time-varying

##Model 2: further adjusted for income
mod_aalen2 <- update(mod_aalen1, ~. + factor(income_5))
summary(mod_aalen2) 

##Model 3: further adjusted for income, marital status, smoking, BMI and alcohol
mod_aalen3 <- update(mod_aalen2, ~. + factor(maritalstatus)) 
summary(mod_aalen3) 

##Model 4: model with mediators and confounders as time-variant 
mod_aalen4 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + factor(dataid) +
              factor(maritalstatus) + factor(income_5) + factor(alcohol7d_4) + 
factor(smokstatus) + factor(bmicat), data=interactionsincome) 
summary(mod_aalen4) 
plot(mod_aalen4)

##Model 5: interaction term income*alcohol (Table 2, model 1)
mod_aalen5 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + factor(maritalstatus) + 
const(factor(alcohol7d_4))*const(factor(income_5)), data=interactionsincome, rob=0) 
summary(mod_aalen5)

##Model 6: interaction term income*smoking (Table 2, model 2)
mod_aalen6 <- aalen(Surv(bl_age, end_age, statusbin) ~  
    factor(sex) + const(factor(dataid)) + factor(maritalstatus) +
      const(factor(smokstatus))*const(factor(income_5)), data=interactionsincome) 
summary(mod_aalen6)

##Model 7: interaction term income*BMI (Table 2, model 3)
mod_aalen7 <- aalen(Surv(bl_age, end_age, statusbin) ~  
    factor(sex) + const(factor(dataid)) + factor(maritalstatus) +  
      const(factor(bmicat))*const(factor(income_5)), data=interactionsincome)
summary(mod_aalen7)

##Model 8: interaction alcohol*smoking (Table 2, model 4)
mod_aalen8 <- aalen(Surv(bl_age, end_age, statusbin) ~  
    factor(sex) + const(factor(dataid)) + factor(maritalstatus) +  
      const(factor(alcohol7d_4))*const(factor(smokstatus)), data=interactionsincome) 
summary(mod_aalen8)

##Model 9: interaction alcohol*BMI (Table 2, model 5)
mod_aalen9 <- aalen(Surv(bl_age, end_age, statusbin) ~  
    factor(sex) + const(factor(dataid)) + factor(maritalstatus) +  
      const(factor(alcohol7d_4))*const(factor(bmicat)), data=interactionsincome) 
summary(mod_aalen9)

#Storing results
saveRDS(mod_aalen5, "mod_aalen5.rds")
saveRDS(mod_aalen6, "mod_aalen6.rds")
saveRDS(mod_aalen7, "mod_aalen7.rds")
saveRDS(mod_aalen8, "mod_aalen8.rds")
saveRDS(mod_aalen9, "mod_aalen9.rds")

#Retrieving
mod_aalen5 <- readRDS("~/mod_aalen5.rds")
summary(mod_aalen5)



```



## Explanation for Seppo and Pia

```{r}
binary <- interactionsincome %>%
  filter(income_5==1 | income_5==5) 

#difference method
## minimally-adjusted model
aalen1 <- aalen(Surv(bl_age, end_age, statusbin) ~  const(factor(income_5)) + factor(sex) + 
const(factor(dataid)) + factor(maritalstatus), data=interactionsincome, robust=0) 
summary(aalen1)
aalen1$gamma[1]

## equation with alcohol
aalen2 <- aalen(Surv(bl_age, end_age, statusbin) ~  const(factor(income_5)) + const(factor(alcohol7d_4)) + factor(sex) + 
const(factor(dataid)) + factor(maritalstatus), data=interactionsincome, robust=0) 
summary(aalen2)
aalen2$gamma[1]

#product method
## equation with Y as the outcome
aalen2$gamma[1]
aalen2$gamma[7]

## multinomal equation
alcoholmed <- vglm(alcohol7d_4 ~ income_5 + sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))
summary(alcoholmed)
alcoholmed@coefficients[["income_51:3"]]

#model with exposure-mediator interaction
aalen3 <- aalen(Surv(bl_age, end_age, statusbin) ~  const(factor(income_5))*const(factor(alcohol7d_4)) + factor(sex) + 
const(factor(dataid)) + factor(maritalstatus), data=interactionsincome, robust=0) 
summary(aalen3)
aalen3$gamma[1]
aalen3$gamma[7]
alcoholmed@coefficients[["income_51:3"]]
aalen3$gamma[23]


aalen3 <- aalen(Surv(bl_age, end_age, statusbin) ~  const(factor(income_5)) + const(factor(alcohol7d_4)) + factor(sex) + 
const(factor(dataid)) + factor(maritalstatus) +  + const(factor(smokstatus)), data=interactionsincome, robust=0) 
summary(aalen3)
aalen3$gamma[8]

alcoholmed <- vglm(alcohol7d_4 ~ income_5 + sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = binary, multinomial(refLevel=1))

alcoholbin <- glm(alcohol7d_4 ~ income_5 + sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = binary, family=binomial(link="logit"))
summary(alcoholbin)
summary(fitM1)

aalen4 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + factor(maritalstatus) + const(factor(income_5)) + const(factor(alcohol7d_4)) + const(factor(bmicat)), data=interactionsincome, robust=0) 
summary(aalen4)
aalen4$gamma[8]


mod_aalen5 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + factor(maritalstatus) + 
const(factor(alcohol7d_4))*const(factor(income_5)), data=interactionsincome, robust=0) 
summary(mod_aalen5)
mod_aalen5$gamma[10]





```


## Stratified results 

```{r stratfied effects, eval=FALSE}
#Subsetting the data
lowincome <- (interactionsincome[interactionsincome$income_5=='1',])
highincome <- (interactionsincome[interactionsincome$income_5=='5',])
table(interactionsincome$income_5)

#Model 5: interaction term SES*alcohol 
##(Table 2, model 6)
mod_aalen5li <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) +
factor(maritalstatus) +  const(factor(alcohol7d_4)), data=lowincome) 
summary(mod_aalen5li)

mod_aalen5   <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + factor(maritalstatus) + 
const(factor(alcohol7d_4))*const(factor(income_5)), data=interactionsincome) 
summary(mod_aalen5)

##(Table 2, model 11)
mod_aalen5hi <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) +  const(factor(alcohol7d_4)), data=highincome) 
summary(mod_aalen5hi)

##Model 6: interaction term SES*smoking
##(Table 2, model 7)
mod_aalen6li <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(smokstatus)), data=lowincome) 
summary(mod_aalen6li)

##(Table 2, model 12)
mod_aalen6hi <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(smokstatus)), data=highincome) 
summary(mod_aalen6hi)

#Model 7: interaction term SES*BMI 
##(Table 2, model 8)
mod_aalen7li <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(bmicat)), data=lowincome) 
summary(mod_aalen7li)

##(Table 2, model 13)
mod_aalen7hi <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(bmicat)), data=highincome) 
summary(mod_aalen7hi)

#Model 8: interaction alcohol*smoking
##(Table 2, model 9)
lowalcohol <- (interactionsincome[interactionsincome$alcohol7d_5=='1',])
highalcohol <- (interactionsincome[interactionsincome$alcohol7d_4=='4',])

mod_aalen8la <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(smokstatus)), data=lowalcohol) 
summary(mod_aalen8la)

##(Table 2, model 14)
mod_aalen8ha <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(smokstatus)), data=highalcohol) 
summary(mod_aalen8ha)

#Model 9: interaction alcohol*BMI
##(Table 2, model 10)
mod_aalen9la <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(bmicat)), data=lowalcohol) 
summary(mod_aalen9la)

##(Table 2, model 15)
mod_aalen9ha <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
const(factor(dataid)) + 
factor(maritalstatus) + const(factor(bmicat)), data=highalcohol) 
summary(mod_aalen9ha)

#Store results
saveRDS(mod_aalen5li, "mod_aalen5li.rds")
saveRDS(mod_aalen6li, "mod_aalen6li.rds")
saveRDS(mod_aalen7li, "mod_aalen7li.rds")
saveRDS(mod_aalen8la, "mod_aalen8li.rds")
saveRDS(mod_aalen9la, "mod_aalen9li.rds")

saveRDS(mod_aalen5hi, "mod_aalen5hi.rds")
saveRDS(mod_aalen6hi, "mod_aalen6hi.rds")
saveRDS(mod_aalen7hi, "mod_aalen7hi.rds")
saveRDS(mod_aalen8ha, "mod_aalen8hi.rds")
saveRDS(mod_aalen9ha, "mod_aalen9hi.rds")

#Retrieving
mod_aalen5li <- readRDS("~/mod_aalen5li.rds")
summary(mod_aalen5li)

mod_aalen5hi <- readRDS("~/mod_aalen5hi.rds")
summary(mod_aalen5hi)


```


## Quantifying the contribution of mediators to income inequalities in alcohol-
attributable mortality

In this article, we used the approach developed by Lange (2014) to quantify the 
relationships between exposure (income) and mediators (M1=alcohol, M2=smoking, M3=BMI). 
The process involves four steps:
1. We first fitted multinomial logistic regressions with the mediators M1, M2 and M3 as
the outcome.
2. We constructed copies of the dataset to account for all possible combinations of the 
exposure and mediators (5^3*= 125). The dataset is expanded from 53,632 to 6,704,000 
pseudobservations. 
3. In the expanded dataset, we calculated weights for each mediator using the predicted 
probabilities from the models fitted in step 1. We calculated a final weight by 
multiplying weights 1, 2 and 3 (one for each mediator)
4. We fitted a marginal structural model using Aalen additive hazards with the weight as 
weight and the id as a cluster level. This ensures that robust standard errors are 
calculated.

The model with robust variance and resampling (robust=TRUE) took approximately 10 days 
to run in a computer with an Intel Xeon W-2145 processor with 3,70 GHz with 16 cores 
and 64 GB of RAM, with a Linux Kubuntu version 18.04. We initially ran the models with the 
robust variance set to zero (robust=0) for testing, which is a much quicker process (30-60 
mins).  


```{r msm, eval=FALSE}
interactionsincome$ATemp <- interactionsincome$income_5

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))

#Testing the results (see whether they change by using a different reference level)
fittest1 <- vglm(alcohol7d_4 ~ income_5 + sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))
predict(fittest1,type = "response", newdata=interactionsincome)

fittest2<- vglm(alcohol7d_4 ~ income_5 + sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=4))
predict(fittest2,type = "response", newdata=interactionsincome)


summary(fittest1)

summary(fitM1)
head(depvar(fitM1), 4)
colSums(depvar(fitM1))
fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(age_5) + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(interactionsincome)
interactionsincome$id <- 1:N
levelsOfExp <- unique(interactionsincome$income_5) 
myData1 <- interactionsincome 
myData2 <- interactionsincome 
myData3 <- interactionsincome 
myData4 <- interactionsincome 
myData5 <- interactionsincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
finalaalen <-  aalen(Surv(bl_age, end_age, statusbin) ~
const(factor(income_5))*const(factor(incomeStar1)) +   
const(factor(income_5))*const(factor(incomeStar2)) +
const(factor(income_5))*const(factor(incomeStar3)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=0)
summary(finalaalen)
finalaalen$gamma[1]

mad <-  aalen(Surv(bl_age, end_age, statusbin) ~ const(factor(income_5)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=myDataexpanded, robust=0)
summary(mad)
mad$gamma[1]



table(interactionsincome$income_5, interactionsincome$alcohol7d_4)

```

## Confidence intervals for the previous analyses

We obtained estimates and standard errors for direct, indirect and mediated effects 
directly from the model output. The timereg package calculates 95% confidence intervals 
with the non-robust standard error and thus we recalculated the confidence intervals using the robust standard 
error. For total effects and combined indirect effects, we used a simulation procedure 
from Nordhal 2014 with some adaptations to obtain the standard error and 95% CI for the 
combined indirect effect (not reported in the Nordhal paper). 

We also tested the boostrapping procedure described by Fritz 2017 (code not included in 
the final version), but the boot package failed and R session collapsed every time we ran 
the code. 


```{r ci, eval=FALSE}
#Retrieving results of the final model with robust standard error
finalaalen <- readRDS("~/fitYaalen_rob.rds")
summary(finalaalen)

#Function to obtain 95% CI of total effect and mediated proportion
getTE <- function(finalaalen, v)
{
TE <- sum(finalaalen$gamma[v])
mu <- finalaalen$gamma[v]
Omega <- finalaalen$robvar.gamma[v,v]           
#this could be replaced by var.gamma to obtain non-robust estimates
temp <- mvrnorm(n=10^4, mu=mu, Sigma=Omega)
temp_TE <- apply(temp,1,sum)
med_prop <- c(mu/TE,1)
med_prop_CI <- rbind(t(apply(temp/temp_TE, 2, quantile, c(0.025, 0.975))), c(1,1))
output <- cbind(c(mu,TE), c(apply(temp,2,sd),sd(temp_TE)), med_prop, med_prop_CI) 
colnames(output) <- c("Est.", "SE", "med_prop", "lowerCI", "UpperCI")
rownames(output) <- c(rownames(finalaalen$gamma)[v],"TE")
return(output)
}

#Function to obtain SE for indirect effect
getIE <- function(finalaalen, v)
{
IE <- sum(finalaalen$gamma[v])
mu <- finalaalen$gamma[v]
Omega <- finalaalen$robvar.gamma[v,v]
require(MASS)
temp <- mvrnorm(n=10^4, mu=mu, Sigma=Omega)
temp_IE <- apply(temp,1,sum)
med_prop <- c(mu/IE,1)
med_prop_CI <- rbind(t(apply(temp/temp_IE, 2, quantile, c(0.025, 0.975))), c(1,1))
output <- cbind(c(mu,IE), c(apply(temp,2,sd),sd(temp_IE)), med_prop, med_prop_CI) 
colnames(output) <- c("Est.", "SE", "med_prop", "lowerCI", "UpperCI")
rownames(output) <- c(rownames(finalaalen$gamma)[v],"IE")
return(output)
}

#Function to obtain 95% CI of mediated proportion of the indirect effect
getTE_IE <- function(finalaalen, v, z)
{
#total effect
TE <- sum(finalaalen$gamma[v])
mu <- finalaalen$gamma[v]
Omega <- finalaalen$robvar.gamma[v,v]
require(MASS)
temp <- mvrnorm(n=10^4, mu=mu, Sigma=Omega)
temp_TE <- apply(temp,1,sum)

IE <- sum(finalaalen$gamma[z])
muIE <- finalaalen$gamma[z]
OmegaIE <- finalaalen$robvar.gamma[z,z]
require(MASS)
tempIE <- mvrnorm(n=10^4, mu=muIE, Sigma=OmegaIE)
temp_IE <- apply(tempIE,1,sum)
med_prop <- c(IE/TE,1)
med_prop_CI <- (temp_IE/temp_TE)
output <- cbind(IE, med_prop, quantile) 
quantile <- quantile(med_prop_CI, c(0.025, 0.975))
output <- cbind(IE, med_prop, quantile)
return(output)
}

#Final results

summary(finalaalen)                                               
#Estimates and SE
getTE(finalaalen, c(1,5,9,13,24,40,56))                           
#Simulated estimate and SE for total effect and mediated proportions for other effects
getIE(finalaalen, c(5,9,13,24,40,56))                             
#Estimate and simulated SE for indirect combined effect
getTE_IE(finalaalen, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))    
#Mediated proportion and simulated 95% CI for mediated proportion of indirect combined effect

```


## Testing whether pathways between alcohol and smoking are intertwined

We examined whether the mediators have intertwined pathways. The pathways are intertwined, 
which we acknowledged as a limitation. 

1. Alcohol and smoking

```{r, eval=FALSE}
#Copy of SES variable
interactionsincome$ATemp <- interactionsincome$income_5

#Multinomial model with alcohol use as outcome
#Mediator 1. The code from Nordhal lets vglm to choose the reference level. 
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))
summary(fitM1)

##Same model but using multinominal logistic regression
fitM1_multinom <- multinom(alcohol7d_4 ~ factor(ATemp)+ factor(age_5) + sex + 
factor(dataid) + factor(maritalstatus), data = interactionsincome)
summary(fitM1_multinom)             #Exact same coefficients

##Mediator 2. Multinomial model with smoking as outcome
fitM2 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) 
+ factor(maritalstatus), data = interactionsincome, 
family=multinomial(refLevel=1))
summary(fitM2)

##Same model but using multinominal logistic regression
fitM2_multinom <- multinom(smokstatus ~ factor(ATemp)+ sex + factor(age_5) 
+ factor(dataid) + factor(maritalstatus), data = interactionsincome)
summary(fitM2_multinom)             #Exact same coefficients

##Multinomial model with alcohol use included
fitM3 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) 
              + factor(maritalstatus) + factor(alcohol7d_4), 
              data = interactionsincome, family=multinomial(refLevel=1))
summary(fitM3)
anova(fitM3, test="Chisq")

fitM3_multinom <- multinom(smokstatus ~ factor(ATemp)+ sex + factor(age_5) 
+ factor(dataid) + factor(maritalstatus) + factor(alcohol7d_4), data = interactionsincome)
summary(fitM3_multinom)             #Exact same coefficients

#Comparing model M2 with M3
anova(fitM3)
anova(fitM2_multinom, fitM3_multinom)
lrtest_vglm(fitM2, fitM3)

```


2. Alcohol and BMI

```{r, eval=FALSE}
#Multinomial model with alcohol use as outcome
#fitM1
##Mediator 2. Multinomial model with smoking as outcome
fitM4 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, family=multinomial(refLevel=2))
summary(fitM4)

##Multinomial model with alcohol use included
fitM5 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus) + 
factor(alcohol7d_4), 
              data = interactionsincome, family=multinomial(refLevel=2))
summary(fitM5)

#Comparing model M4 with M5
anova(fitM5)
lrtest_vglm(fitM4, fitM5)

```

2. Smoking and BMI

```{r, eval=FALSE}
#Multinomial model with alcohol use as outcome
#fitM1
##Mediator 2. Multinomial model with smoking as outcome
fitM6 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, family=multinomial(refLevel=1))
summary(fitM6)

##Multinomial model with alcohol use included
fitM7 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus) + 
factor(bmicat), 
              data = interactionsincome, family=multinomial(refLevel=1))
summary(fitM7)

#Comparing model M4 with M5
anova(fitM7)
lrtest_vglm(fitM6, fitM7)

```


## Sensitivity analyses

### 1. Stratified by sex

Results for males

```{r males, eval=FALSE}
sa_maleincome <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus,
maritalstatus, bmicat, alcohol7d_4) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4)) %>%
  filter(sex=="1")

#Multinomial model with alcohol use as outcome
sa_maleincome$ATemp <- sa_maleincome$income_5
fitM1_males <- vglm(alcohol7d_4 ~ factor(ATemp)+ factor(dataid) + factor(maritalstatus),
                    data = sa_maleincome, multinomial())

fitM2_males <- vglm(smokstatus ~  factor(ATemp)+ factor(dataid) + factor(maritalstatus), 
                    data = sa_maleincome, multinomial())

fitM3_males <- vglm(bmicat ~      factor(ATemp)+ factor(dataid) + factor(maritalstatus), 
                    data = sa_maleincome, multinomial())

#Construct copies of ID and SES
N <- nrow(sa_maleincome)
sa_maleincome$id <- 1:N
levelsOfExp <- unique(sa_maleincome$income_5) 
myData1 <- sa_maleincome 
myData2 <- sa_maleincome 
myData3 <- sa_maleincome 
myData4 <- sa_maleincome 
myData5 <- sa_maleincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3_males,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- 
myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1_males, fitM2_males, fitM3_males, tempDir1, tempDir2, tempDir3, tempIndir1, 
tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_male <-  aalen(Surv(bl_age, end_age, statusbin) ~ const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + const(factor(income_5))*const(factor(incomeStar3)) + 
  const(factor(dataid)) +  factor(maritalstatus) , data=myDataexpanded, weights=myDataexpanded$weight, 
clusters=myDataexpanded$id, robust=T)
summary(fitYaalen_male)

saveRDS(fitYaalen_male, "fitYaalen_male_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_male <- readRDS("~/fitYaalen_male_rob.rds")

summary(fitYaalen_male)
getTE(fitYaalen_male, c(1,5,9,13,25,41,57))
getIE(fitYaalen_male, c(5,9,13,25,41,57))
getTE_IE(fitYaalen_male, c(1,5,9,13,25,41,57), c(5,9,13,25,41,57))


```


Results for females

```{r females, eval=FALSE}
sa_femaleincome <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid)) %>%
  filter(sex=="0")

#Multinomial model with alcohol use as outcome
sa_femaleincome$ATemp <- sa_femaleincome$income_5

fitM1_female <- vglm(alcohol7d_4 ~ factor(ATemp)+ factor(dataid) + factor(maritalstatus), 
data = sa_femaleincome, multinomial())

fitM2_female <- vglm(smokstatus ~ factor(ATemp)+ factor(dataid) + factor(maritalstatus), 
data = sa_femaleincome,
multinomial())

fitM3_female <- vglm(bmicat ~ factor(ATemp)+ factor(dataid) + factor(maritalstatus), 
                     data = sa_femaleincome, multinomial())

#Construct copies of ID and SES
N <- nrow(sa_femaleincome)
sa_femaleincome$id <- 1:N
levelsOfExp <- unique(sa_femaleincome$income_5) 
myData1 <- sa_femaleincome 
myData2 <- sa_femaleincome 
myData3 <- sa_femaleincome 
myData4 <- sa_femaleincome 
myData5 <- sa_femaleincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3_female,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- 
myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1_female, fitM2_female, fitM3_female, tempDir1, tempDir2, tempDir3, tempIndir1, 
tempIndir2, tempIndir3)

#Fit marginal structural model
aalen_female <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
                         const(factor(income_5))*const(factor(incomeStar1)) +
                         const(factor(income_5))*const(factor(incomeStar2)) + 
                         const(factor(income_5))*const(factor(incomeStar3)) + 
                         const(factor(dataid)) +  factor(maritalstatus), 
                       data=myDataexpanded, weights=myDataexpanded$weight, 
clusters=myDataexpanded$id, robust=T)
summary(aalen_female)
saveRDS(aalen_female, "fitYaalen_female_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_female <- readRDS("~/fitYaalen_female_rob.rds")
summary(fitYaalen_female)
getTE(fitYaalen_female, c(1,5,9,13,25,41,57))
getIE(fitYaalen_female, c(5,9,13,25,41,57))
getTE_IE(fitYaalen_female, c(1,5,9,13,25,41,57), c(5,9,13,25,41,57))
  
```



### 2. Sensitivity analyses using HED as an alternative variable of alcohol use

```{r, sensitivity HED}
hedincome <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, age_5, dataid, 
                smokstatus, maritalstatus, hed, bmi, bmicat, alcohol7d_5, 
                alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, age_5, 
                        dataid, smokstatus, maritalstatus, hed, alcohol7d_4, bmicat)) %>%
  filter(dataid=="H2000" | dataid=="FINRISK02" | dataid=="FINRISK07") 

table(hedincome$hed, hedincome$dataid)
#Recode hed variable
hedincome <- hedincome %>%
  mutate(hed = recode(hed, "3"=4, "2"=3, "1"=2, "0"=1))
table(hedincome$hed, hedincome$dataid)

#Total effect in pooled dataset
mad_hedincome <-  aalen(Surv(bl_age, end_age, statusbin) ~ const(factor(income_5)) +
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=hedincome, robust=0)
summary(mad_hedincome)

table(hedincome$hed, hedincome$income_5)

# Analysis using the main model in the subset data
hedincome$ATemp <- hedincome$income_5

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedincome, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(age_5) + factor(dataid) + factor(maritalstatus), 
              data = hedincome, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedincome, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(hedincome)
hedincome$id <- 1:N
levelsOfExp <- unique(hedincome$income_5) 
myData1 <- hedincome 
myData2 <- hedincome 
myData3 <- hedincome 
myData4 <- hedincome 
myData5 <- hedincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpandedhedincome <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$alcohol7d_4)]

myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$incomeStar1 
tempIndir1  <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$alcohol7d_4)]

myDataexpandedhedincome$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$income_5 
tempDir2  <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$smokstatus)]

myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$smokstatus)]

myDataexpandedhedincome$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$income_5 
tempDir3   <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$bmicat)]

myDataexpandedhedincome$ATemp <- myDataexpandedhedincome$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedincome))[cbind(1:nrow(myDataexpandedhedincome), myDataexpandedhedincome$bmicat)]

myDataexpandedhedincome$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpandedhedincome$weight <- myDataexpandedhedincome$weight1*myDataexpandedhedincome$weight2*myDataexpandedhedincome$weight3

#Checking stability of weights
hist(myDataexpandedhedincome$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
finalaalen_hedincome <-  aalen(Surv(bl_age, end_age, statusbin) ~
const(factor(income_5))*const(factor(incomeStar1)) +   
const(factor(income_5))*const(factor(incomeStar2)) +
const(factor(income_5))*const(factor(incomeStar3)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=myDataexpandedhedincome, 
weights=myDataexpandedhedincome$weight, clusters=myDataexpandedhedincome$id, robust=T)
summary(finalaalen_hedincome)
finalaalen_hedincome$gamma[1]

saveRDS(finalaalen_hedincome, "hedincome_aalen.rds")

#Retrieve results of the final model and calculate all effects
finalaalen_hedincome <- readRDS("~/hedincome_aalen.rds")
summary(finalaalen_hedincome)

getTE(finalaalen_hedincome, c(1,5,9,13,19,35,51))
getIE(finalaalen_hedincome, c(5,9,13,19,35,51))
getTE_IE(finalaalen_hedincome, c(1,5,9,13,19,35,51), c(5,9,13,19,35,51))


# Analysis using HED as an alternative

hedincome$ATemp <- hedincome$income_5

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(hed ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedincome, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(age_5) + factor(dataid) + factor(maritalstatus), 
              data = hedincome, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedincome, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(hedincome)
hedincome$id <- 1:N
levelsOfExp <- unique(hedincome$income_5) 
myData1 <- hedincome 
myData2 <- hedincome 
myData3 <- hedincome 
myData4 <- hedincome 
myData5 <- hedincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
expandedhed <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
expandedhed$ATemp <- expandedhed$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$hed)]

expandedhed$ATemp <- expandedhed$incomeStar1 
tempIndir1  <- as.matrix(predict(fitM1,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$hed)]

expandedhed$weight1 <- tempIndir1/tempDir1

##Mediator smoking
expandedhed$ATemp <- expandedhed$income_5 
tempDir2  <- as.matrix(predict(fitM2,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$smokstatus)]

expandedhed$ATemp <- expandedhed$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$smokstatus)]

expandedhed$weight2 <- tempIndir2/tempDir2

##Mediator BMI
expandedhed$ATemp <- expandedhed$income_5 
tempDir3   <- as.matrix(predict(fitM3,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$bmicat)]

expandedhed$ATemp <- expandedhed$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=expandedhed))[cbind(1:nrow(expandedhed), expandedhed$bmicat)]

expandedhed$weight3 <- tempIndir3/tempDir3

#Final weight
expandedhed$weight <- expandedhed$weight1*expandedhed$weight2*expandedhed$weight3

#Checking stability of weights
hist(expandedhed$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
finalaalen_hedincomealt <-  aalen(Surv(bl_age, end_age, statusbin) ~
const(factor(income_5))*const(factor(incomeStar1)) +   
const(factor(income_5))*const(factor(incomeStar2)) +
const(factor(income_5))*const(factor(incomeStar3)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=expandedhed, 
weights=expandedhed$weight, clusters=expandedhed$id, robust=T)
summary(finalaalen_hedincomealt)


saveRDS(finalaalen_hedincomealt, "hedincome_alt_aalen_rob.rds")

#Retrieve results of the final model and calculate all effects
finalaalen_hedincomealt <- readRDS("~/hedincome_alt_aalen_rob.rds")
summary(finalaalen_hedincomealt)

getTE(finalaalen_hedincomealt, c(1,5,9,13,19,35,51))
getIE(finalaalen_hedincomealt, c(5,9,13,19,35,51))
getTE_IE(finalaalen_hedincomealt, c(1,5,9,13,19,35,51), c(5,9,13,19,35,51))

```


### 3. Sensitivity analyses using education as exposure

```{r edu, eval=FALSE}
interactionseducation <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, edulevel_3, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, edulevel_3, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4)) 

#Converting into a factor variable with correct labels
interactionseducation$edulevel_3 <- factor(interactionseducation$edulevel_3, levels = 
c(3,1,2))
levels(interactionseducation$edulevel_3)

#Creating transitory education variable
interactionseducation$ATemp <- interactionseducation$edulevel_3

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionseducation, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionseducation, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionseducation, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(interactionseducation)
interactionseducation$id <- 1:N
levelsOfExp <- unique(interactionseducation$edulevel_3) 
myData1 <- interactionseducation 
myData2 <- interactionseducation 
myData3 <- interactionseducation 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
tempMyData <- rbind(myData1,myData2,myData3)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
tempMyData <- rbind(myData1,myData2,myData3)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myDataexpanded <- rbind(myData1,myData2,myData3)

rm(myData1, myData2, myData3, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$edulevel_3 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$edulevel_3 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$edulevel_3 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_edu <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(edulevel_3))*const(factor(incomeStar1)) + 
const(factor(edulevel_3))*const(factor(incomeStar2)) + 
const(factor(edulevel_3))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus) , data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T)
summary(fitYaalen_edu)

saveRDS(fitYaalen_edu, "fitYaalen_edu_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_edu <- readRDS("fitYaalen_edu_rob.rds")
summary(fitYaalen_edu)

getTE(fitYaalen_edu, c(1,3,5,7,16,20,24))
getIE(fitYaalen_edu, c(3,5,7,16,20,24))
getTE_IE(fitYaalen_edu, c(1,3,5,7,16,20,24), c(3,5,7,16,20,24))



```

### 4. Sensitivity analysis by follow-up time

Results if follow-up less than 10 years


```{r tenyears, eval=FALSE}
tenyrs_income <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid)) %>%
  mutate(fup=end_age-bl_age) %>%
  filter(fup<=10)

#Multinomial model with alcohol use as outcome
tenyrs_income$ATemp <- tenyrs_income$income_5
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = tenyrs_income, multinomial())

fitM2 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = tenyrs_income, multinomial())

fitM3 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), data = 
tenyrs_income, multinomial())

#Construct copies of ID and SES
N <- nrow(tenyrs_income)
tenyrs_income$id <- 1:N
levelsOfExp <- unique(tenyrs_income$income_5) 
myData1 <- tenyrs_income 
myData2 <- tenyrs_income 
myData3 <- tenyrs_income 
myData4 <- tenyrs_income 
myData5 <- tenyrs_income 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_tenyrs <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T)
summary(fitYaalen_tenyrs)

saveRDS(fitYaalen_tenyrs, "aalen_ten_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_tenyrs <- readRDS("~/aalen_ten_rob.rds")

summary(fitYaalen_tenyrs)
getTE(fitYaalen_tenyrs, c(1,5,9,13,24,40,56))
getIE(fitYaalen_tenyrs, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_tenyrs, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))

```


Results if follow-up less than 20 years

```{r twentyyears, eval=FALSE}
twentyrs_income <- biomarkers %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, maritalstatus, 
bmicat, alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid)) %>%
  mutate(fup=end_age-bl_age) %>%
  filter(fup<=20)

#Multinomial model with alcohol use as outcome
twentyrs_income$ATemp <- twentyrs_income$income_5
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = twentyrs_income, multinomial())

fitM2 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = twentyrs_income, multinomial())

fitM3 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), data = 
twentyrs_income, multinomial())

#Construct copies of ID and SES
N <- nrow(twentyrs_income)
twentyrs_income$id <- 1:N
levelsOfExp <- unique(twentyrs_income$income_5) 
myData1 <- twentyrs_income 
myData2 <- twentyrs_income 
myData3 <- twentyrs_income 
myData4 <- twentyrs_income 
myData5 <- twentyrs_income 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))
[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- 
myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_twenty <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T)
summary(fitYaalen_twenty)

saveRDS(fitYaalen_twenty, "aalen_twenty_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_twenty <- readRDS("~/aalen_twenty_rob.rds")

summary(fitYaalen_twenty)
getTE(fitYaalen_twenty, c(1,5,9,13,24,40,56))
getIE(fitYaalen_twenty, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_twenty, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))

```


Results if follow-up less than 30 years

```{r thirtyyears, eval=FALSE}
thirtyrs_income <- interactionsincome %>% 
  dplyr::select(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid) %>%
  filter(complete.cases(bl_age, end_age, statusbin, sex, income_5, dataid, smokstatus, 
maritalstatus, bmicat, alcohol7d_4, dataid)) %>%
  mutate(fup=end_age-bl_age) %>%
  filter(fup<=30)

#Multinomial model with alcohol use as outcome
thirtyrs_income$ATemp <- thirtyrs_income$income_5
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = thirtyrs_income, multinomial())

fitM2 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
data = thirtyrs_income, multinomial())

fitM3 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), data = 
thirtyrs_income, multinomial())

#Construct copies of ID and SES
N <- nrow(thirtyrs_income)
thirtyrs_income$id <- 1:N
levelsOfExp <- unique(thirtyrs_income$income_5) 
myData1 <- thirtyrs_income 
myData2 <- thirtyrs_income 
myData3 <- thirtyrs_income 
myData4 <- thirtyrs_income 
myData5 <- thirtyrs_income 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_thirty <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T)
summary(fitYaalen_thirty)

saveRDS(fitYaalen_thirty, "fitYaalen_thirty_rob.rds")

#Retrieve results of the final model and calculate all effects
fitYaalen_thirty <- readRDS("fitYaalen_thirty_rob.rds")
summary(fitYaalen_thirty)

getTE(fitYaalen_thirty, c(1,5,9,13,26,42,58))
getIE(fitYaalen_thirty, c(5,9,13,26,42,58))
getTE_IE(fitYaalen_thirty, c(1,5,9,13,26,42,58), c(5,9,13,26,42,58))

```



### 5. Sensitivity analyses stratifying by age to assess the impact of time-varying effects

Testing time-varying covariates

```{r tvc_test, eval=FALSE}
##Model to test TVC
mod_aalen4_tvc <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + factor(dataid) + 
factor(maritalstatus) + factor(income_5) + factor(smokstatus) + factor(bmicat) + 
factor(alcohol7d_4), data=interactionsincome) 
summary(mod_aalen4_tvc)
plot(mod_aalen4_tvc)
saveRDS(mod_aalen4, "aalen_tvc")

#Testing whether the TVC when splitting the time in four subgroups. This solves the PH 
#violation

mod_aalen4_tvc_40 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
factor(dataid) + factor(maritalstatus) + factor(income_5) + 
factor(smokstatus) + factor(bmicat) + factor(alcohol7d_4), data=interactionsincome, 
max.time=39.999) 
summary(mod_aalen4_tvc_40)
plot(mod_aalen4_tvc_40)

mod_aalen4_tvc_4055 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
factor(dataid) + factor(maritalstatus) + factor(income_5) + factor(smokstatus) + 
factor(bmicat) + factor(alcohol7d_4), data=interactionsincome, start.time=40, 
max.time=54.999) 
summary(mod_aalen4_tvc_4055)

mod_aalen4_tvc_5570 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) + 
factor(dataid) + factor(maritalstatus) + factor(income_5) + factor(smokstatus) + 
factor(bmicat) + factor(alcohol7d_4), data=interactionsincome, start.time=55, 
max.time=69.999) 
summary(mod_aalen4_tvc_5570)

mod_aalen4_tvc_70 <- aalen(Surv(bl_age, end_age, statusbin) ~  factor(sex) +
factor(dataid) + factor(maritalstatus) + factor(income_5) + factor(smokstatus) + 
factor(bmicat) + factor(alcohol7d_4), data=interactionsincome, start.time=70) 
summary(mod_aalen4_tvc_70)

```


Causal mediation analysis

``` {r tvc msm, eval=FALSE}
interactionsincome$ATemp <- interactionsincome$income_5

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~ factor(ATemp)+ sex + factor(dataid) + factor(maritalstatus), 
              data = interactionsincome, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(interactionsincome)
interactionsincome$id <- 1:N
levelsOfExp <- unique(interactionsincome$income_5) 
myData1 <- interactionsincome 
myData2 <- interactionsincome 
myData3 <- interactionsincome 
myData4 <- interactionsincome 
myData5 <- interactionsincome 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpanded <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar1 
tempIndir1 <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded),myDataexpanded$alcohol7d_4)]

myDataexpanded$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$smokstatus)]

myDataexpanded$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpanded$ATemp <- myDataexpanded$income_5 
tempDir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$ATemp <- myDataexpanded$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpanded))[cbind(1:nrow(myDataexpanded), myDataexpanded$bmicat)]

myDataexpanded$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpanded$weight <- myDataexpanded$weight1*myDataexpanded$weight2*myDataexpanded$weight3

#Checking stability of weights
hist(myDataexpanded$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
fitYaalen_40 <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T, max.time=39.999)
summary(fitYaalen_40)

fitYaalen_4055 <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T, start.time=40, 
max.time=54.999)
summary(fitYaalen_4055)

fitYaalen_5570 <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T, start.time=55, 
max.time=69.999)
summary(fitYaalen_5570)

fitYaalen_70 <-  aalen(Surv(bl_age, end_age, statusbin) ~ 
const(factor(income_5))*const(factor(incomeStar1)) + 
const(factor(income_5))*const(factor(incomeStar2)) + 
const(factor(income_5))*const(factor(incomeStar3)) + const(factor(dataid)) + 
factor(sex) + factor(maritalstatus), data=myDataexpanded, 
weights=myDataexpanded$weight, clusters=myDataexpanded$id, robust=T, start.time=70)
summary(fitYaalen_70)

saveRDS(fitYaalen_40, "fitYaalen_40_rob.rds")
saveRDS(fitYaalen_4055, "fitYaalen_4055_rob.rds")
saveRDS(fitYaalen_5570, "fitYaalen_5570_rob.rds")
saveRDS(fitYaalen_70, "fitYaalen_70_rob.rds")


#Results
fitYaalen_40 <- readRDS("fitYaalen_40_rob.rds")
summary(fitYaalen_40)
getTE(fitYaalen_40, c(1,5,9,13,24,40,56))
getIE(fitYaalen_40, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_40, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))

fitYaalen_4055 <- readRDS("fitYaalen_4055_rob.rds")
getTE(fitYaalen_4055, c(1,5,9,13,24,40,56))
getIE(fitYaalen_4055, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_4055, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))

fitYaalen_5570 <- readRDS("fitYaalen_5570_rob.rds")
getTE(fitYaalen_5570, c(1,5,9,13,24,40,56))
getIE(fitYaalen_5570, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_5570, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))

fitYaalen_70 <- readRDS("fitYaalen_70_rob.rds")
getTE(fitYaalen_70, c(1,5,9,13,24,40,56))
getIE(fitYaalen_70, c(5,9,13,24,40,56))
getTE_IE(fitYaalen_70, c(1,5,9,13,24,40,56), c(5,9,13,24,40,56))


```



### 5. Sensitivity analyses stratifying by HED 


```{r}
#sensitivity analyses stratified by HED
hedincome <- hedincome %>%
  mutate(hedbin = recode(hed, "2"=1))

table(hedincome$hed, hedincome$hedbin)
table(hedincome$hedbin)

hedplus <- hedincome %>%
  filter(hedbin==1)

hedneg <- hedincome %>%
  filter(hedbin==0)


hedplus$ATemp <- hedplus$income_5

#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedplus, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(age_5) + factor(dataid) + factor(maritalstatus), 
              data = hedplus, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedplus, multinomial(refLevel="(18.5,25]"))



#Construct copies of ID and SES
N <- nrow(hedplus)
hedplus$id <- 1:N
levelsOfExp <- unique(hedplus$income_5) 
myData1 <- hedplus 
myData2 <- hedplus 
myData3 <- hedplus 
myData4 <- hedplus 
myData5 <- hedplus 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpandedhedplus <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus),myDataexpandedhedplus$alcohol7d_4)]

myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$incomeStar1 
tempIndir1  <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus),myDataexpandedhedplus$alcohol7d_4)]

myDataexpandedhedplus$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$income_5 
tempDir2  <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus), myDataexpandedhedplus$smokstatus)]

myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus), myDataexpandedhedplus$smokstatus)]

myDataexpandedhedplus$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$income_5 
tempDir3   <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus), myDataexpandedhedplus$bmicat)]

myDataexpandedhedplus$ATemp <- myDataexpandedhedplus$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedplus))[cbind(1:nrow(myDataexpandedhedplus), myDataexpandedhedplus$bmicat)]

myDataexpandedhedplus$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpandedhedplus$weight <- myDataexpandedhedplus$weight1*myDataexpandedhedplus$weight2*myDataexpandedhedplus$weight3

#Checking stability of weights
hist(myDataexpandedhedplus$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
finalaalen_hedplus <-  aalen(Surv(bl_age, end_age, statusbin) ~
const(factor(income_5))*const(factor(incomeStar1)) +   
const(factor(income_5))*const(factor(incomeStar2)) +
const(factor(income_5))*const(factor(incomeStar3)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=myDataexpandedhedplus, 
weights=myDataexpandedhedplus$weight, clusters=myDataexpandedhedplus$id, robust=T)
summary(finalaalen_hedplus)
finalaalen_hedplus$gamma[1]

saveRDS(finalaalen_hedplus, "hedplus_aalen_rob.rds")


#sensitivity analysis stratified in HED (HED==1)
hedneg$ATemp <- hedneg$income_5
table(hedneg$maritalstatus)
#Multinomial model with alcohol use as outcome
fitM1 <- vglm(alcohol7d_4 ~ factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedneg, multinomial(refLevel=1))

fitM2 <- vglm(smokstatus ~  factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedneg, multinomial(refLevel=1))

fitM3 <- vglm(bmicat ~      factor(ATemp)+ sex + factor(age_5) + factor(dataid) + 
factor(maritalstatus), 
              data = hedneg, multinomial(refLevel="(18.5,25]"))

#Construct copies of ID and SES
N <- nrow(hedneg)
hedneg$id <- 1:N
levelsOfExp <- unique(hedneg$income_5) 
myData1 <- hedneg 
myData2 <- hedneg 
myData3 <- hedneg 
myData4 <- hedneg 
myData5 <- hedneg 

myData1$incomeStar1 <- levelsOfExp[1] 
myData2$incomeStar1 <- levelsOfExp[2] 
myData3$incomeStar1 <- levelsOfExp[3] 
myData4$incomeStar1 <- levelsOfExp[4] 
myData5$incomeStar1 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar2 <- levelsOfExp[1] 
myData2$incomeStar2 <- levelsOfExp[2] 
myData3$incomeStar2 <- levelsOfExp[3] 
myData4$incomeStar2 <- levelsOfExp[4]
myData5$incomeStar2 <- levelsOfExp[5] 
tempMyData <- rbind(myData1,myData2,myData3, myData4, myData5)

myData1 <- tempMyData 
myData2 <- tempMyData 
myData3 <- tempMyData 
myData4 <- tempMyData 
myData5 <- tempMyData 
myData1$incomeStar3 <- levelsOfExp[1] 
myData2$incomeStar3 <- levelsOfExp[2] 
myData3$incomeStar3 <- levelsOfExp[3] 
myData4$incomeStar3 <- levelsOfExp[4]
myData5$incomeStar3 <- levelsOfExp[5] 
myDataexpandedhedneg <- rbind(myData1,myData2,myData3, myData4, myData5)

rm(myData1, myData2, myData3, myData4, myData5, tempMyData)

#Construct the weights
##Mediator alcohol
myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$income_5 
tempDir1    <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg),myDataexpandedhedneg$alcohol7d_4)]

myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$incomeStar1 
tempIndir1  <- as.matrix(predict(fitM1,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg),myDataexpandedhedneg$alcohol7d_4)]

myDataexpandedhedneg$weight1 <- tempIndir1/tempDir1

##Mediator smoking
myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$income_5 
tempDir2  <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg), myDataexpandedhedneg$smokstatus)]

myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$incomeStar2 
tempIndir2 <- as.matrix(predict(fitM2,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg), myDataexpandedhedneg$smokstatus)]

myDataexpandedhedneg$weight2 <- tempIndir2/tempDir2

##Mediator BMI
myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$income_5 
tempDir3   <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg), myDataexpandedhedneg$bmicat)]

myDataexpandedhedneg$ATemp <- myDataexpandedhedneg$incomeStar3 
tempIndir3 <- as.matrix(predict(fitM3,type = "response", newdata=myDataexpandedhedneg))[cbind(1:nrow(myDataexpandedhedneg), myDataexpandedhedneg$bmicat)]

myDataexpandedhedneg$weight3 <- tempIndir3/tempDir3

#Final weight
myDataexpandedhedneg$weight <- myDataexpandedhedneg$weight1*myDataexpandedhedneg$weight2*myDataexpandedhedneg$weight3

#Checking stability of weights
hist(myDataexpandedhedneg$weight)


rm(fitM1, fitM2, fitM3, tempDir1, tempDir2, tempDir3, tempIndir1, tempIndir2, tempIndir3)

#Fit marginal structural model
finalaalen_hedneg <-  aalen(Surv(bl_age, end_age, statusbin) ~
const(factor(income_5))*const(factor(incomeStar1)) +   
const(factor(income_5))*const(factor(incomeStar2)) +
const(factor(income_5))*const(factor(incomeStar3)) + 
const(factor(dataid)) + factor(sex) + factor(maritalstatus), data=myDataexpandedhedneg, 
weights=myDataexpandedhedneg$weight, clusters=myDataexpandedhedneg$id, robust=T)
summary(finalaalen_hedneg)
finalaalen_hedneg$gamma[1]

saveRDS(finalaalen_hedneg, "hedneg_aalen_rob.rds")

#results
summary(finalaalen_hedincome)
summary(finalaalen_hedplus)
summary(finalaalen_hedneg)

```
```

The end